name: Deploy Preview

on:
  push:
    branches-ignore:
      - main
    paths:
      - "docs/**"
      - "scripts/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/preview-deployment.yml"

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-preview:
    # Avoid infinite loop if bot commits
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Ensure reveal assets in docs
        run: pnpm run prepare-reveal

      - name: Extract branch name
        id: branch
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          # Sanitize branch name for directory usage (replace / with -)
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          echo "name=$SAFE_BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "original=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create preview directory
        run: |
          PREVIEW_DIR="docs/preview/${{ steps.branch.outputs.name }}"
          
          # Remove existing preview if it exists
          rm -rf "$PREVIEW_DIR"
          
          # Create preview directory
          mkdir -p "$PREVIEW_DIR"
          
          # Copy docs content to preview (excluding preview directory itself)
          rsync -av --exclude='preview' docs/ "$PREVIEW_DIR/"

      - name: Commit preview to main branch
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Store current branch for returning later
          CURRENT_BRANCH="${{ steps.branch.outputs.original }}"
          
          # Fetch main branch
          git fetch origin main
          
          # Checkout main branch
          git checkout main
          
          # Copy preview from feature branch
          git checkout "$CURRENT_BRANCH" -- "docs/preview/${{ steps.branch.outputs.name }}" || {
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Failed to checkout preview directory"
            git checkout "$CURRENT_BRANCH"
            exit 0
          }
          
          # Add files to staging
          git add "docs/preview/${{ steps.branch.outputs.name }}"
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            # Commit and push to main
            git commit -m "chore: update preview for $CURRENT_BRANCH"
            git push origin main
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
          # Always return to feature branch
          git checkout "$CURRENT_BRANCH"

      - name: Find Pull Request
        if: steps.commit.outputs.changed == 'true'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`
            });
            
            if (pulls.length > 0) {
              return pulls[0].number;
            }
            return null;

      - name: Comment preview URL on PR
        if: steps.commit.outputs.changed == 'true' && steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const branchName = '${{ steps.branch.outputs.name }}';
            const previewUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/preview/${branchName}/`;
            
            const body = `## ðŸ” Preview Deployment
            
            Preview URL: ${previewUrl}
            
            The preview has been deployed to \`docs/preview/${branchName}/\` and will be available once this PR is merged or when the branch is pushed to main.
            
            _Note: Preview is deployed on this branch. To view it live, merge this PR or check GitHub Pages settings._`;
            
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
